<!-- @author Stanisław Polak <polak@agh.edu.pl> -->

<!DOCTYPE html>
<html>
<head>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <title>
        Example 3
    </title>
</head>
<body>
<div id="root">
    <!--
        Container for the component.
        React renders the specified HTML code inside the so-called container,
        i.e. the element of the website we choose.
    -->
</div>
<!-- The 'Hello' component -->
<script type="text/babel" data-type="module">
    import React from "https://esm.sh/react/?dev";
    import ReactDOMClient from "https://esm.sh/react-dom/client/?dev";

    const CounterContext  = React.createContext(undefined);

    function Counter() {
        const data = React.useContext(CounterContext);

        return (
            <>
            <h2>requestAnimationFrame()</h2>
            <label htmlFor="counter">Counter→</label>
            <output id="counter" style={{fontSize:'4vh',color:'red' }}>${data.start}</output>
            <br />
                <button id="start" onClick={startAnimation}>Start</button>
                <button id="stop" disabled onClick={stopAnimation}>Stop</button>
            </>
        );

    }

    const xs  = {
        start: 100,
    }
    function App(){
        return (
            <>
                <form onSubmit={(event) => event.preventDefault()}>
                    <CounterContext.Provider value={xs}>
                        <Counter />
                    </CounterContext.Provider>

                    <hr />
                    <h2>Time-consuming calculations in the main thread</h2>
                    <label htmlFor="result_main">Result:</label>
                    <output id="result_main">0</output>
                    <br />
                    <label htmlFor="iterations_main">Number of iterations:</label>
                    <input id="iterations_main" type="text" defaultValue="50" onFocus={() => document.forms[0].result_main.value = '0'} />
                    <button
                        type="button"
                        onClick={() => {
                            document.forms[0].result_main.value = calculatePrimes(document.forms[0].iterations_main.value || 50);
                        }}
                    >
                        Run calculations
                    </button>

                    <h2>Time-consuming calculations in a separate thread</h2>
                    <label htmlFor="result_worker">Result:</label>
                    <output id="result_worker">0</output>
                    <br />
                    <label htmlFor="iterations_worker">Number of iterations:</label>
                    <input id="iterations_worker" type="text" defaultValue="50" onFocus={() => document.forms[0].result_worker.value = '0'} />
                    <button
                        type="button"
                        onClick={() => calculatePrimesInBackground(document.forms[0].iterations_worker.value || 50)}
                    >
                        Run calculations
                    </button>
                </form>
                </>
        );

    }

    let animation;
    const worker = new Worker('worker.js');

    worker.onerror = function(event) {

        console.error("ERROR: " + event.message);
    }

    // Source: https://udn.realityripple.com/docs/Tools/Performance/Scenarios/Intensive_JavaScript
    function calculatePrimes(iterations) {
        let primes = [];
        for (let i = 0; i < iterations; i++) {
            let candidate = i * (1000000000 * Math.random());
            let isPrime = true;
            for (var c = 2; c <= Math.sqrt(candidate); ++c) {
                if (candidate % c === 0) {
                    // not prime
                    isPrime = false;
                    break;
                }
            }
            if (isPrime) {
                primes.push(candidate);
            }
        }
        return primes;
    }

    function calculatePrimesInBackground(iterations) {

        worker.postMessage(iterations);

    }

    worker.onmessage = (message) => {

        document.forms[0].result_worker.value = message.data;

    }

    function startAnimation() {
        document.forms[0].start.disabled = true;
        document.forms[0].stop.disabled = false;
        animation = window.requestAnimationFrame(step);
    }

    function step() {
        document.forms[0].counter.value = counter++;
        animation = window.requestAnimationFrame(step);
    }

    function stopAnimation() {
        document.forms[0].start.disabled = false;
        document.forms[0].stop.disabled = true;
        window.cancelAnimationFrame(animation)
    }

    const container = document.getElementById('root'); // Retrieving references per container
    const root = ReactDOMClient.createRoot(container); // Creating a React root for the given container
    root.render(<App/>);      // Component rendering
</script>
</body>
</html>