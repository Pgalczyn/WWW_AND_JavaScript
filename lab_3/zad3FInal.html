<!-- @author Stanisław Polak <polak@agh.edu.pl> -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    let animation;
    let counter = 0;
    const worker = new Worker('worker.js');

    worker.onerror = function(event) {

      console.error("ERROR: " + event.message);
    }

    // Source: https://udn.realityripple.com/docs/Tools/Performance/Scenarios/Intensive_JavaScript
    function calculatePrimes(iterations) {
      let primes = [];
      for (let i = 0; i < iterations; i++) {
        let candidate = i * (1000000000 * Math.random());
        let isPrime = true;
        for (var c = 2; c <= Math.sqrt(candidate); ++c) {
          if (candidate % c === 0) {
            // not prime
            isPrime = false;
            break;
          }
        }
        if (isPrime) {
          primes.push(candidate);
        }
      }
      return primes;
    }

    function calculatePrimesInBackground(iterations) {

      worker.postMessage(iterations);

    }

    worker.onmessage = (message) => {

      document.forms[0].result_worker.value = message.data;

    }

    function startAnimation() {
      document.forms[0].start.disabled = true;
      document.forms[0].stop.disabled = false;
      animation = window.requestAnimationFrame(step);
    }

    function step() {
      document.forms[0].counter.value = counter++;
      animation = window.requestAnimationFrame(step);
    }

    function stopAnimation() {
      document.forms[0].start.disabled = false;
      document.forms[0].stop.disabled = true;
      window.cancelAnimationFrame(animation)
    }

  </script>
  <title>
    Example 3
  </title>
</head>
<body>
<div id="root">
  <!--
      Container for the component.
      React renders the specified HTML code inside the so-called container,
      i.e. the element of the website we choose.
  -->
</div>

<form onsubmit="event.preventDefault();">
  <h2>requestAnimationFrame()</h2>
  <label for="counter">Counter→</label>
  <output id="counter" style="font-size: 4vh; color: red;">0</output>
  <br>
  <button id="start" onclick="startAnimation()">Start</button>
  <button id="stop" disabled onclick="stopAnimation()">Stop</button>
  <!-- ************************************************************** -->
  <hr>
  <h2>Time-consuming calculations in the main thread</h2>
  <label for="result_main">Result:</label>
  <output id="result_main">0</output>
  <br>
  <label for="iterations_main">Number of iterations:</label>
  <input id="iterations_main" type="text" value="50" onfocus="document.forms[0].result_main.value ='0'">
  <button
          onclick="document.forms[0].result_main.value = calculatePrimes(document.forms[0].iterations_main.value || 50)">Run
    calculations</button>
  <!-- ************************************************************** -->
  <h2>Time-consuming calculations in a separate thread</h2>
  <label for="result_worker">Result:</label>
  <output id="result_worker">0</output>
  <br>
  <label for="iterations_worker">Number of iterations:</label>
  <input id="iterations_worker" type="text" value="50" onfocus="document.forms[0].result_worker.value ='0'">
  <button
          onclick="calculatePrimesInBackground(document.forms[0].iterations_worker.value || 50)">Run
    calculations</button>
</form>
<!-- The 'Hello' component -->

<script type="text/babel" data-type="module">
  import React,{ useState, useEffect,useRef } from "https://esm.sh/react/?dev";
  import ReactDOMClient from "https://esm.sh/react-dom/client/?dev";



  function Counter(props) {

   const [counter, setCount] = useState(parseInt(props.initialValue));
   const [isRunning, setIsRunning] = useState(false)
  let intervalRef = useRef();


   const increment = () => setCount(prev => prev + 1);

   useEffect(() => {
     if (isRunning) {
       intervalRef.current = setInterval(() => {
         increment()
       }, props.timeBreak);
     }
     return () => {
       clearInterval(intervalRef.current);
     }


   },[isRunning]);

   const handleStop = () => {
     setIsRunning(false);
   }
   const handleStart = () => {
     setIsRunning(true);
   }




    return (
            <>
              <div className='container bg-success text-white p-3 mt-1 rounded'>
                  <div className='d-flex flex-row align-items-center'>
                    <label>Counter → </label>
                    <p className="text-danger fs-2 mb-0 fw-bold">{ counter }</p>
                  </div>
                <button onClick={handleStart} className="btn btn-primary me-1"> start</button>
                <button onClick={handleStop} className="btn btn-primary"> stop</button>
              </div>

              </>
    )
  }

  const container = document.getElementById('root'); // Retrieving references per container
  const root = ReactDOMClient.createRoot(container); // Creating a React root for the given container
  root.render(<Counter initialValue = '1000' timeBreak = '100' />);      // Component rendering
</script>
</body>
</html>